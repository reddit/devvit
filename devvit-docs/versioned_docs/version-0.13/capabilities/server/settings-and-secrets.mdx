import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Settings and Secrets

Configure your app with settings that can be customized per subreddit or globally across all installations. Settings allow moderators to customize app behavior for their subreddit, while secrets enable secure storage of sensitive data like API keys.

Settings come in two scopes:
- **Subreddit settings**: Configurable by moderators for each installation
- **Global settings & Secrets**: Set by developers and shared across all installations

## Defining settings

Settings are defined differently depending on whether you're using Devvit Web or Devvit Blocks.

<Tabs>
  <TabItem value="web" label="Devvit Web">
  Define settings in your `devvit.json` file under the `settings` object. Settings are organized by scope: `global` for app-wide settings and secrets, `subreddit` for installation-specific settings.

  ```json title="devvit.json"
  {
    "settings": {
      "global": {
        "apiKey": {
          "type": "string",
          "label": "API Key",
          "defaultValue": "",
          "isSecret": true
        },
        "environment": {
          "type": "select",
          "label": "Environment",
          "options": [
            {
              "label": "Production",
              "value": "production"
            },
            {
              "label": "Development",
              "value": "development"
            }
          ],
          "defaultValue": "production"
        }
      },
      "subreddit": {
        "welcomeMessage": {
          "type": "string",
          "label": "Welcome Message",
          "validationEndpoint": "/internal/settings/validate-message",
          "defaultValue": "Welcome to our community!"
        },
        "enabledFeatures": {
          "type": "multiSelect",
          "label": "Enabled Features",
          "options": [
            {
              "label": "Auto-moderation",
              "value": "automod"
            },
            {
              "label": "Welcome posts",
              "value": "welcome"
            },
            {
              "label": "Statistics tracking",
              "value": "stats"
            }
          ],
          "defaultValue": ["welcome"]
        }
      }
    }
  }
  ```

  :::note
  After defining settings in `devvit.json`, you must build your app (`npm run dev`) before you can set secrets via the CLI.
  :::
  </TabItem>
  <TabItem value="blocks" label="Devvit Blocks">
  Use `Devvit.addSettings` to define settings with the appropriate scope.

  ```tsx title="main.tsx"
  import { Devvit, SettingScope } from '@devvit/public-api';

  Devvit.addSettings([
    // Global secret
    {
      type: 'string',
      name: 'apiKey',
      label: 'API Key',
      isSecret: true,
      scope: SettingScope.App, // or 'app'
    },
    // Global setting
    {
      type: 'select',
      name: 'environment',
      label: 'Environment',
      options: [
        { label: 'Production', value: 'production' },
        { label: 'Development', value: 'development' },
      ],
      scope: 'app',
    },
    // Subreddit setting
    {
      type: 'string',
      name: 'welcomeMessage',
      label: 'Welcome Message',
      scope: SettingScope.Installation, // or 'installation'
      onValidate: async ({ value }) => {
        if (!value || value.length < 5) {
          return 'Message must be at least 5 characters';
        }
      },
    },
    // Subreddit multi-select
    {
      type: 'select',
      name: 'enabledFeatures',
      label: 'Enabled Features',
      options: [
        { label: 'Auto-moderation', value: 'automod' },
        { label: 'Welcome posts', value: 'welcome' },
        { label: 'Statistics tracking', value: 'stats' },
      ],
      multiSelect: true,
      scope: 'installation',
    },
  ]);
  ```
  </TabItem>
</Tabs>

## Setting types

Both frameworks support the following setting types:

- **string**: Text input field
- **boolean**: Toggle switch
- **number**: Numeric input
- **select**: Dropdown selection (single choice)
- **multiSelect** (Web) / **select with multiSelect: true** (Blocks): Multiple choice dropdown
- **paragraph**: Multi-line text input (Blocks only)
- **group**: Grouped settings for organization (Blocks only)

## Managing secrets

Secrets are global settings marked with `isSecret: true`. They're encrypted and can only be set by developers via the CLI.

### Listing secrets

View all defined secrets in your app:

```bash
npx devvit settings list

Key          Label         Is this a secret?   Type
──────────   ───────────   ─────────────────   ──────
apiKey       API Key       true                STRING
environment  Environment   false               SELECT
```

### Setting secret values

Only app developers can set secret values:

```bash
npx devvit settings set apiKey

? Enter the value you would like to assign to the variable apiKey: <value>

Updating app settings... ✅
Successfully added app settings for apiKey!
```

:::warning
At least one app installation is required before you can store secrets via the CLI. You can run `npx devvit playtest` (or `npm run dev` in Devvit Web) to start your first installation.
:::

## Accessing settings in your app

Settings can be retrieved from within your app.

<Tabs>
  <TabItem value="web" label="Devvit Web">
  ```tsx title="server/index.ts"
  import { settings } from '@devvit/web/server';

  // Get a single setting
  const apiKey = await settings.get('apiKey');
  
  // Get multiple settings
  const [welcomeMessage, features] = await Promise.all([
    settings.get('welcomeMessage'),
    settings.get('enabledFeatures')
  ]);

  // Use in an endpoint
  router.post('/api/process', async (req, res) => {
    const apiKey = await settings.get('apiKey');
    const environment = await settings.get('environment');
    
    const response = await fetch('https://api.example.com/endpoint', {
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'X-Environment': environment
      }
    });
    
    res.json({ success: true });
  });
  ```
  </TabItem>
  <TabItem value="blocks" label="Devvit Blocks">
  ```tsx title="main.tsx"
  import { Devvit } from '@devvit/public-api';

  Devvit.addMenuItem({
    label: 'Process with API',
    location: 'subreddit',
    onPress: async (_event, context) => {
      // Get individual settings
      const apiKey = await context.settings.get('apiKey');
      const welcomeMessage = await context.settings.get('welcomeMessage');
      
      // Get all settings
      const allSettings = await context.settings.getAll();
      
      // Use the settings
      const response = await fetch('https://api.example.com/endpoint', {
        headers: {
          'Authorization': `Bearer ${apiKey}`,
        }
      });
      
      context.ui.showToast(`Processed with message: ${welcomeMessage}`);
    },
  });

  // Access in custom post type
  Devvit.addCustomPostType({
    name: 'ConfigurablePost',
    render: (context) => {
      const [features, setFeatures] = useState<string[]>([]);
      
      useEffect(async () => {
        const enabledFeatures = await context.settings.get('enabledFeatures');
        setFeatures(enabledFeatures || []);
      }, []);
      
      return (
        <vstack>
          <text>Enabled features: {features.join(', ')}</text>
        </vstack>
      );
    },
  });
  ```
  </TabItem>
</Tabs>

## Input validation

Validate user input to ensure it meets your requirements before saving.

<Tabs>
  <TabItem value="web" label="Devvit Web">
  Define a validation endpoint in your `devvit.json` and implement it in your server:

  ```json title="devvit.json"
  {
    "settings": {
      "subreddit": {
        "minimumAge": {
          "type": "number",
          "label": "Minimum Account Age (days)",
          "validationEndpoint": "/internal/settings/validate-age",
          "defaultValue": 7
        }
      }
    }
  }
  ```

  ```tsx title="server/index.ts"
  import { SettingsValidationRequest, SettingsValidationResponse } from '@devvit/web/server';

  router.post(
    '/internal/settings/validate-age',
    async (
      req: Request<unknown, unknown, SettingsValidationRequest<number>>,
      res: Response<SettingsValidationResponse>
    ): Promise<void> => {
      const { value } = req.body;

      if (!value || value < 0) {
        res.json({
          success: false,
          error: 'Age must be a positive number',
        });
        return;
      }

      if (value > 365) {
        res.json({
          success: false,
          error: 'Maximum age is 365 days',
        });
        return;
      }

      res.json({ success: true });
    }
  );
  ```
  </TabItem>
  <TabItem value="blocks" label="Devvit Blocks">
  Add an `onValidate` handler to your setting definition:

  ```tsx title="main.tsx"
  Devvit.addSettings([
    {
      type: 'number',
      name: 'minimumAge',
      label: 'Minimum Account Age (days)',
      scope: 'installation',
      onValidate: async ({ value }) => {
        if (!value || value < 0) {
          return 'Age must be a positive number';
        }
        if (value > 365) {
          return 'Maximum age is 365 days';
        }
      },
    },
  ]);
  ```
  </TabItem>
</Tabs>

## Subreddit settings UI

Once your app is installed, moderators can configure subreddit settings through the Install Settings page. These settings are scoped to the specific subreddit where the app is installed.

<!-- ![Settings configuration interface](../assets/capabilities/app-configurations/app-configurations-all-types.png) -->

Moderators will see all non-secret settings defined for the subreddit scope and can update them as needed. Changes are saved immediately and available to your app.

## Complete example

Here's a complete example showing both secrets and subreddit settings in action:

<Tabs>
  <TabItem value="web" label="Devvit Web">
  ```json title="devvit.json"
  {
    "settings": {
      "global": {
        "openaiApiKey": {
          "type": "string",
          "label": "OpenAI API Key",
          "isSecret": true,
          "defaultValue": ""
        }
      },
      "subreddit": {
        "aiModel": {
          "type": "select",
          "label": "AI Model",
          "options": [
            { "label": "GPT-4", "value": "gpt-4" },
            { "label": "GPT-3.5", "value": "gpt-3.5-turbo" }
          ],
          "defaultValue": "gpt-3.5-turbo"
        },
        "maxTokens": {
          "type": "number",
          "label": "Max Response Tokens",
          "validationEndpoint": "/internal/settings/validate-tokens",
          "defaultValue": 150
        }
      }
    }
  }
  ```

  ```tsx title="server/index.ts"
  import { settings } from '@devvit/web/server';

  router.post('/api/generate', async (req, res) => {
    const [apiKey, model, maxTokens] = await Promise.all([
      settings.get('openaiApiKey'),
      settings.get('aiModel'),
      settings.get('maxTokens')
    ]);

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model,
        max_tokens: maxTokens,
        messages: req.body.messages,
      }),
    });

    const data = await response.json();
    res.json(data);
  });
  ```
  </TabItem>
  <TabItem value="blocks" label="Devvit Blocks">
  ```tsx title="main.tsx"
  import { Devvit } from '@devvit/public-api';

  Devvit.configure({
    http: true,
  });

  Devvit.addSettings([
    {
      name: 'openaiApiKey',
      label: 'OpenAI API Key',
      type: 'string',
      isSecret: true,
      scope: 'app',
    },
    {
      name: 'aiModel',
      label: 'AI Model',
      type: 'select',
      options: [
        { label: 'GPT-4', value: 'gpt-4' },
        { label: 'GPT-3.5', value: 'gpt-3.5-turbo' },
      ],
      scope: 'installation',
    },
    {
      name: 'maxTokens',
      label: 'Max Response Tokens',
      type: 'number',
      scope: 'installation',
      onValidate: async ({ value }) => {
        if (value < 1 || value > 500) {
          return 'Tokens must be between 1 and 500';
        }
      },
    },
  ]);

  async function generateResponse(context: Devvit.Context, prompt: string): Promise<string> {
    const [apiKey, model, maxTokens] = await Promise.all([
      context.settings.get('openaiApiKey'),
      context.settings.get('aiModel'),
      context.settings.get('maxTokens'),
    ]);

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model,
        max_tokens: maxTokens,
        messages: [{ role: 'user', content: prompt }],
      }),
    });

    const data = await response.json();
    return data.choices[0]?.message?.content || 'No response';
  }

  Devvit.addCustomPostType({
    name: 'AI Assistant',
    render: (context) => {
      const [response, setResponse] = useState('');

      return (
        <vstack gap="medium" padding="medium">
          <button 
            onPress={async () => {
              const result = await generateResponse(context, 'Hello!');
              setResponse(result);
            }}
          >
            Generate Response
          </button>
          {response && <text>{response}</text>}
        </vstack>
      );
    },
  });

  export default Devvit;
  ```
  </TabItem>
</Tabs>

## Limitations

- Secrets can only be global
- Secrets can only be set via CLI by app developers
- Setting values are currently not fully surfaced in the CLI
- Maximum of 2KB per setting value
